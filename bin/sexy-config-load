#!/bin/sh
# 
# 2009      Nico Schottelius (nico-sexy at schottelius.org)
# 
# This file is part of sexy.
#
# sexy is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# sexy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with sexy. If not, see <http://www.gnu.org/licenses/>.
#
#
# Load the configuration - this script should be sourced
#

################################################################################
# standard vars stolen from cconf, renamed for sexy
__sexy_pwd="$(pwd -P)"
__sexy_mydir="${0%/*}"; __sexy_abs_mydir="$(cd "$__sexy_mydir" && pwd -P)"
__sexy_myname=${0##*/}; __sexy_abs_myname="$__sexy_abs_mydir/$__sexy_myname"


# where our database can be found
sexy_db="${sexy_db:-$HOME/.sexy}"
sexy_db_abs="$(cd "${sexy_db}" && pwd -P)"

#
# Determine the current configuration directory
# A very mysterious, powerfull expression:
# Use the sexy db base + config + # Remove the database path, add the sexy db base + config +  
#
sexy_my_config="${sexy_db_abs}/config${__sexy_abs_mydir##$sexy_db_abs}"

sexy_objects="backends hosts networks tags"

for sexy_object in $sexy_objects; do
   # This is the same as
   # : ${sexy_path_backends:="backends"}
   # just for variable names
   eval \: \${sexy_path_${sexy_object}:="$sexy_object"}

   #
   # Create full path in db, like
   # sexy_db_backends="${sexy_db}/${sexy_path_networks}"
   #
   eval sexy_db_${sexy_object}="\"${sexy_db}/\${sexy_path_${sexy_object}}\""

   #
   # The path to the configuration (if available) for an object.
   #
   eval sexy_db_config_${sexy_object}="\"${sexy_db}/config/\${sexy_path_${sexy_object}}\""

   # Debug output
   # eval echo "\${sexy_db_${sexy_object}}"
done
sexy_object=""

# What cares about what
sexy_object_types="${sexy_path_hosts} ${sexy_path_networks}"
sexy_runner_known="${sexy_path_hosts}"

sexy_usage()
{
   echo "${__sexy_myname}: $@"
   exit 1
}

# argument(s) should not be empty
sexy_notempty()
{
   errormsg="$1"; shift

   while [ "$#" -gt 0 ]; do
      if [ "$1" ]; then
         shift
      else
         sexy_usage "$errormsg"
      fi
   done
}

sexy_args()
{

   count=0
   arglist=""

   # get argument list
   while [ "$1" != "--" ]; do
      eval arg_$count=\"$1\"
      arglist="$arglist $1"
      shift
      count=$(($count+1))
   done
   shift; # skip --

   if [ "$#" -ne "$count" ]; then
      sexy_usage "${arglist}"
   fi

   # assign values
   count=0
   while [ "$#" -gt 0 ]; do
      eval export \$arg_$count=\"$1\"
      shift
      count=$(($count+1))
   done
}
